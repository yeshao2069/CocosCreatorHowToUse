{"version":3,"sources":["file:///Users/mu/work/gitee/cocos-creator-how-to-use/proj/Performance/Creator3.5.0_3D_VBBatch/assets/script/framework/util/subPackageManager.ts"],"names":["_decorator","ccclass","property","SubPackageManager","dictLoading","dictPackage","instance","_instance","loadSubPackage","packageName","finishCb","window","wx","hasOwnProperty","loadSubpackage","name","success","arrLoading","forEach","cb","fail","err","console","error","push","loadAudioPackage","isAudioPackageLoad","loadModelPackage","loadAllPackage"],"mappings":";;;;;;;;AAASA,MAAAA,U,OAAAA,U;;;;;;;OACH;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBF,U;;mCAGjBG,iB,WADZF,OAAO,CAAC,mBAAD,C,2BAAR,MACaE,iBADb,CAC+B;AAAA;AAAA,eAe3BC,WAf2B,GAeR,EAfQ;AAAA,eAgB3BC,WAhB2B,GAgBR,EAhBQ;AAAA;;AAMR,mBAARC,QAAQ,GAAI;AACnB,cAAI,KAAKC,SAAT,EAAoB;AAChB,mBAAO,KAAKA,SAAZ;AACH;;AAED,eAAKA,SAAL,GAAiB,IAAIJ,iBAAJ,EAAjB;AACA,iBAAO,KAAKI,SAAZ;AACH;;AAKDC,QAAAA,cAAc,CAAEC,WAAF,EAAuBC,QAAvB,EAA2C;AACrD,cAAIC,MAAM,CAACC,EAAX,EAAe;AACX;AACA,gBAAI,KAAKP,WAAL,CAAiBQ,cAAjB,CAAgCJ,WAAhC,CAAJ,EAAkD;AAC9CC,cAAAA,QAAQ,IAAIA,QAAQ,CAAC,IAAD,CAApB;AACA;AACH,aAHD,MAGO;AACH,kBAAI,CAAC,KAAKN,WAAL,CAAiBS,cAAjB,CAAgCJ,WAAhC,CAAL,EAAmD;AAC/C,qBAAKL,WAAL,CAAiBK,WAAjB,IAAgC,EAAhC;AAEAE,gBAAAA,MAAM,CAACC,EAAP,CAAUE,cAAV,CAAyB;AACrBC,kBAAAA,IAAI,EAAEN,WADe;AAErBO,kBAAAA,OAAO,EAAE,MAAI;AACT,yBAAKX,WAAL,CAAiBI,WAAjB,IAAgC,IAAhC;AAEA,wBAAIQ,UAAU,GAAG,KAAKb,WAAL,CAAiBK,WAAjB,CAAjB;AACAQ,oBAAAA,UAAU,CAACC,OAAX,CAAoBC,EAAD,IAAkB;AACjCA,sBAAAA,EAAE,IAAIA,EAAE,CAAC,IAAD,CAAR;AACH,qBAFD;AAIA,2BAAO,KAAKf,WAAL,CAAiBK,WAAjB,CAAP;AACH,mBAXoB;AAYrBW,kBAAAA,IAAI,EAAGC,GAAD,IAAO;AACTC,oBAAAA,OAAO,CAACC,KAAR,uBAAkCd,WAAlC,uBAA+DY,GAA/D,EADS,CAGT;;AACA,wBAAIJ,UAAU,GAAG,KAAKb,WAAL,CAAiBK,WAAjB,CAAjB;AACAQ,oBAAAA,UAAU,CAACC,OAAX,CAAoBC,EAAD,IAAkB;AACjCA,sBAAAA,EAAE,IAAIA,EAAE,CAACE,GAAD,CAAR;AACH,qBAFD;AAIA,2BAAO,KAAKjB,WAAL,CAAiBK,WAAjB,CAAP;AACH;AAtBoB,iBAAzB;AAwBH;;AAED,mBAAKL,WAAL,CAAiBK,WAAjB,EAA8Be,IAA9B,CAAmCd,QAAnC;AACH;AAGJ,WAvCD,MAuCO;AACHA,YAAAA,QAAQ,IAAIA,QAAQ,CAAC,IAAD,CAApB;AACH;AACJ;;AAEDe,QAAAA,gBAAgB,CAAEf,QAAF,EAAsB;AAClC,eAAKF,cAAL,CAAoB,OAApB,EAA6BE,QAA7B;AACH;;AAEDgB,QAAAA,kBAAkB,GAAI;AAClB,iBAAO,CAACf,MAAM,CAACC,EAAR,IAAc,KAAKP,WAAL,CAAiBQ,cAAjB,CAAgC,OAAhC,CAArB;AACH;;AAEDc,QAAAA,gBAAgB,CAAEjB,QAAF,EAAsB;AAClC,eAAKF,cAAL,CAAoB,OAApB,EAA6BE,QAA7B;AACH,SAzE0B,CA2E3B;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;;;AAEAkB,QAAAA,cAAc,GAAI;AACd,eAAKD,gBAAL,CAAsB,MAAI,CAEzB,CAFD;AAIA,eAAKF,gBAAL,CAAsB,MAAI,CAEzB,CAFD,EALc,CASd;AAEA;AAEA;AAEA;AAEA;AAEA;AACH;;AA3G0B,O,UAIpBlB,S","sourcesContent":["import { _decorator, Component, Node } from \"cc\";\nconst { ccclass, property } = _decorator;\n\n@ccclass(\"SubPackageManager\")\nexport class SubPackageManager {\n    /* class member could be defined like this */\n    // dummy = '';\n\n    static _instance: SubPackageManager;\n\n    static get instance () {\n        if (this._instance) {\n            return this._instance;\n        }\n\n        this._instance = new SubPackageManager();\n        return this._instance;\n    }\n\n    dictLoading: any = {}\n    dictPackage: any = {}\n\n    loadSubPackage (packageName: string, finishCb: Function) {\n        if (window.wx) {\n            //微信环境下，需要加载子包\n            if (this.dictPackage.hasOwnProperty(packageName)) {\n                finishCb && finishCb(null);\n                return;\n            } else {\n                if (!this.dictLoading.hasOwnProperty(packageName)) {\n                    this.dictLoading[packageName] = [];\n\n                    window.wx.loadSubpackage({\n                        name: packageName,\n                        success: ()=>{\n                            this.dictPackage[packageName] = true;\n\n                            let arrLoading = this.dictLoading[packageName];\n                            arrLoading.forEach((cb: Function) => {\n                                cb && cb(null);\n                            });\n    \n                            delete this.dictLoading[packageName];\n                        },\n                        fail: (err)=>{\n                            console.error(`load subpackage (${packageName}) failed!! err:${err}`);\n    \n                            // finishCb && finishCb(err);\n                            let arrLoading = this.dictLoading[packageName];\n                            arrLoading.forEach((cb: Function) => {\n                                cb && cb(err);\n                            });\n\n                            delete this.dictLoading[packageName];\n                        }\n                    });\n                }\n\n                this.dictLoading[packageName].push(finishCb);\n            }\n\n            \n        } else {\n            finishCb && finishCb(null);\n        }\n    }\n\n    loadAudioPackage (finishCb: Function) {\n        this.loadSubPackage('audio', finishCb);\n    }\n\n    isAudioPackageLoad () {\n        return !window.wx || this.dictPackage.hasOwnProperty('audio');\n    }\n\n    loadModelPackage (finishCb: Function) {\n        this.loadSubPackage('model', finishCb);\n    }\n\n    // loadCardPackage (finishCb: Function) {\n    //     this.loadSubPackage('card', finishCb);\n    // }\n\n    // loadEffectPackage (finishCb: Function) {\n    //     this.loadSubPackage('effect', finishCb);\n    // }\n\n    // loadBuildingPackage (finishCb: Function) {\n    //     this.loadSubPackage('building', finishCb);\n    // }\n\n    loadAllPackage () {\n        this.loadModelPackage(()=>{\n\n        });\n\n        this.loadAudioPackage(()=>{\n\n        });\n\n        // this.loadCardPackage(()=>{\n\n        // });\n\n        // this.loadEffectPackage(()=>{\n\n        // });\n\n        // this.loadBuildingPackage(()=>{\n            \n        // });\n    }\n}\n"]}