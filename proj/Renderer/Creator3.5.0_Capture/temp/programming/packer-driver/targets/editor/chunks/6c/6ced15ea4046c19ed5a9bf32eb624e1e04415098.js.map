{"version":3,"sources":["file:///Users/mu/work/gitee/cocos-creator-how-to-use/proj/Renderer/Creator3.5.0_Capture/assets/Script/ScreenShot.ts"],"names":["_decorator","Component","Node","Camera","RenderTexture","sys","UITransform","gfx","director","ImageAsset","Texture2D","SpriteFrame","Sprite","view","tween","Vec3","isValid","PREVIEW","Canvas2Image","ccclass","property","ScreenShot","renderTex","_canvas","_buffer","canvas2Image","tempPos","start","getInstance","isNative","console","log","reset","width","getVisibleSize","height","copyCamera","targetTexture","copyNode","getPosition","onBtnSave","capture","scheduleOnce","setPosition","getComponent","spriteFrame","setScale","targetNode","saveAsImage","worldPos","getWorldPosition","rt","texBuffers","Uint8Array","region","BufferTextureCopy","texOffset","x","Math","round","y","texExtent","root","device","copyTextureToBuffers","getGFXTexture","showImage","img","_data","format","PixelFormat","RGBA8888","_compressed","texture","image","sf","packable","flipUVY","setContentSize","doCaptureAnim","scale_fator","arrived_fator","pos","arrivedNode","to","scale","parallel","position","arrayBuffer","isBrowser","document","createElement","clearCanvas","ctx","getContext","rowBytes","row","sRow","imageData","createImageData","i","data","putImageData","saveAsPNG","platform","Platform","WECHAT_GAME","wx","createCanvas","toTempFilePath","destWidth","destHeight","fileType","success","res","showToast","title","saveImageToPhotoaAlbum","filePath","tempFilePath","clearRect"],"mappings":"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","sourcesContent":["\r\nimport { _decorator, Component, Node, Camera, RenderTexture, sys, UITransform, gfx,\r\n    director, ImageAsset, Texture2D, SpriteFrame, Sprite, view, tween, Vec3, isValid\r\n } from 'cc';\r\nimport { PREVIEW } from 'cc/env';\r\nimport { Canvas2Image } from './Canvas2Image';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('ScreenShot')\r\nexport class ScreenShot extends Component {\r\n\r\n    @property(Camera)\r\n    copyCamera: Camera | null = null;\r\n    @property(Node)\r\n    copyNode: Node | null = null;\r\n    @property(Node)\r\n    targetNode: Node | null = null;\r\n    @property(Node)\r\n    arrivedNode: Node | null = null;\r\n    \r\n    renderTex: RenderTexture = null;\r\n    _canvas: HTMLCanvasElement = null;\r\n    _buffer: ArrayBufferView = null;\r\n    canvas2Image: Canvas2Image = null;\r\n    tempPos: Vec3 = new Vec3();\r\n\r\n    start () {\r\n        this.canvas2Image = Canvas2Image.getInstance();\r\n        if (PREVIEW && sys.isNative) {\r\n            console.log(\"暂时不支持模拟器，请构建并测试!\");\r\n            return;\r\n        }\r\n\r\n        this.renderTex = new RenderTexture();\r\n        this.renderTex.reset({\r\n            width: view.getVisibleSize().width,\r\n            height: view.getVisibleSize().height\r\n        });\r\n        this.copyCamera.targetTexture = this.renderTex;\r\n        this.tempPos = this.copyNode.getPosition();\r\n    }\r\n\r\n    onBtnSave () {\r\n        this.capture();\r\n\r\n        // 定时任务\r\n        this.scheduleOnce(() => {\r\n            if (this && this.copyNode && isValid(this.copyNode)) {\r\n                this.copyNode.setPosition(this.tempPos);\r\n                this.copyNode.getComponent(Sprite).spriteFrame = null;\r\n                this.copyNode.setScale(new Vec3(1, 1, 1));\r\n            }\r\n        }, 5);\r\n\r\n        let width = this.targetNode.getComponent(UITransform).width;\r\n        let height = this.targetNode.getComponent(UITransform).height;\r\n        this.saveAsImage(width, height, this._buffer);\r\n    }\r\n\r\n    // 截图\r\n    capture () {\r\n        let width = this.targetNode.getComponent(UITransform).width;\r\n        let height = this.targetNode.getComponent(UITransform).height;\r\n        let worldPos = this.targetNode.getWorldPosition();\r\n        let rt = this.renderTex;\r\n        let texBuffers: ArrayBufferView[] = [];\r\n        texBuffers[0] = new Uint8Array(width * height * 4);\r\n        let region = new gfx.BufferTextureCopy();\r\n        region.texOffset.x = Math.round(worldPos.x);\r\n        region.texOffset.y = Math.round(worldPos.y);\r\n        region.texExtent.width = width;\r\n        region.texExtent.height = height;\r\n        // @ts-ignore\r\n        director.root.device.copyTextureToBuffers(rt.getGFXTexture(), texBuffers, [region]);\r\n        this._buffer = texBuffers[0];\r\n        this.showImage(width, height);\r\n    }\r\n\r\n    showImage (width: number, height: number) {\r\n        let img = new ImageAsset();\r\n        img.reset({\r\n            _data: this._buffer,\r\n            width: width,\r\n            height: height,\r\n            format: Texture2D.PixelFormat.RGBA8888,\r\n            _compressed: false\r\n        });\r\n        let texture = new Texture2D();\r\n        texture.image = img;\r\n        let sf = new SpriteFrame();\r\n        sf.texture = texture;\r\n        sf.packable = false;\r\n        this.copyNode.getComponent(Sprite).spriteFrame = sf;\r\n        this.copyNode.getComponent(Sprite).spriteFrame.flipUVY = true;\r\n        this.copyNode.getComponent(UITransform).setContentSize(width, height);\r\n\r\n        this.doCaptureAnim();\r\n    }\r\n\r\n    // 做截图动画\r\n    doCaptureAnim () {\r\n        if (this.copyNode) {\r\n            let scale_fator = 0.95;\r\n            let arrived_fator = 0.3;\r\n            let pos = this.arrivedNode.getPosition();\r\n            tween(this.copyNode)\r\n                .to(0.2, { scale: new Vec3(scale_fator, scale_fator, 1)})\r\n                .to(0.3, { scale: new Vec3(1, 1, 1)})\r\n                .parallel(\r\n                    tween(this.copyNode).to(0.5, { scale: new Vec3(arrived_fator, arrived_fator, 1)}),\r\n                    tween(this.copyNode).to(0.5, { position: pos})\r\n                ).start();\r\n        }\r\n    }\r\n\r\n    saveAsImage (width: number, height: number, arrayBuffer: ArrayBufferView | number[]) {\r\n        if (sys.isBrowser) {\r\n            if (!this._canvas) {\r\n                this._canvas = document.createElement('canvas');\r\n                this._canvas.width = width;\r\n                this._canvas.height = height;\r\n            } else {\r\n                this.clearCanvas();\r\n            }\r\n            let ctx = this._canvas.getContext('2d')!;\r\n            let rowBytes = width * 4;\r\n            for (let row = 0; row < height; row++) {\r\n                let sRow = height - 1 - row;\r\n                let imageData = ctx.createImageData(width, 1);\r\n                let start = sRow * width * 4;\r\n                for (let i = 0; i < rowBytes; i++) {\r\n                    imageData.data[i] = arrayBuffer[start + i];\r\n                }\r\n                ctx.putImageData(imageData, 0, row);\r\n            }\r\n            // @ts-ignore\r\n            this.canvas2Image.saveAsPNG(this._canvas, width, height);\r\n        } else if (sys.isNative) {\r\n            console.log(\"原生平台暂不支持图片下载\");\r\n            \r\n            return;\r\n        } else if (sys.platform == sys.Platform.WECHAT_GAME) {\r\n            if (!this._canvas) {\r\n                // @ts-ignore\r\n                this._canvas = wx.createCanvas();\r\n                this._canvas.width = width;\r\n                this._canvas.height = height;\r\n            } else {\r\n                this.clearCanvas();\r\n            }\r\n            var ctx = this._canvas.getContext('2d');\r\n            var rowBytes = width * 4;\r\n            for (let row = 0; row < height; row++) {\r\n                let sRow = height - 1 - row;\r\n                let imageData = ctx.createImageData(width, 1);\r\n                let start = sRow * width * 4;\r\n                for (let i = 0; i < rowBytes; i++) {\r\n                    imageData.data[i] = arrayBuffer[start + i];\r\n                }\r\n                ctx.putImageData(imageData, 0, row);\r\n            }\r\n            // @ts-ignore\r\n            this._canvas.toTempFilePath({\r\n                x: 0,\r\n                y: 0,\r\n                width: this._canvas.width,\r\n                height: this._canvas.height,\r\n                destWidth: this._canvas.width,\r\n                destHeight: this._canvas.height,\r\n                fileType: \"png\",\r\n                success: function (res) {\r\n                    // @ts-ignore\r\n                    wx.showToast({ title: \"截图成功\" });\r\n                    // @ts-ignore\r\n                    wx.saveImageToPhotoaAlbum({\r\n                        filePath: res.tempFilePath,\r\n                        success: function (res) {\r\n                            // @ts-ignore\r\n                            wx.showToast({ title: \"成功保存到设备相册\" })\r\n                        }\r\n                    });\r\n                }\r\n            })\r\n        }\r\n    }\r\n\r\n    clearCanvas () {\r\n        let ctx = this._canvas.getContext('2d');\r\n        ctx.clearRect(0, 0, this._canvas.width, this._canvas.height);\r\n    }\r\n}"]}