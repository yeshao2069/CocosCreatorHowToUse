{"version":3,"sources":["file:///Users/mu/work/gitee/cocos-creator-how-to-use/proj/Particle/Creator3.5.1_3D_ParticleTrails01/assets/script/first-person-camera.ts"],"names":["_decorator","Component","game","macro","math","systemEvent","SystemEvent","ccclass","property","Vec2","Vec3","Quat","v2_1","v2_2","v3_1","qt_1","KEYCODE","W","charCodeAt","S","A","D","Q","E","SHIFT","KEY","shift","FirstPersonCamera","slide","range","_euler","_velocity","_position","_speedScale","onLoad","on","EventType","MOUSE_WHEEL","onMouseWheel","KEY_DOWN","onKeyDown","KEY_UP","onKeyUp","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","copy","node","eulerAngles","position","onDestroy","off","update","dt","transformQuat","rotation","scaleAndAdd","moveSpeed","lerp","damp","setPosition","fromEuler","x","y","z","slerp","setRotation","e","delta","getScrollY","UNIT_Z","v","keyCode","moveSpeedShiftScale","canvas","requestPointerLock","t","getStartLocation","width","getDelta","rotateSpeed","getLocation","subtract","document","exitPointerLock"],"mappings":"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","sourcesContent":["import { _decorator, Component, game, macro, math, systemEvent, SystemEvent, EventMouse, EventKeyboard, EventTouch, Touch } from 'cc';\nconst { ccclass, property } = _decorator;\nconst { Vec2, Vec3, Quat } = math;\n\nconst v2_1 = new Vec2();\nconst v2_2 = new Vec2();\nconst v3_1 = new Vec3();\nconst qt_1 = new Quat();\nconst KEYCODE = {\n    W: 'W'.charCodeAt(0),\n    S: 'S'.charCodeAt(0),\n    A: 'A'.charCodeAt(0),\n    D: 'D'.charCodeAt(0),\n    Q: 'Q'.charCodeAt(0),\n    E: 'E'.charCodeAt(0),\n    SHIFT: macro.KEY.shift,\n};\n\n@ccclass\nexport class FirstPersonCamera extends Component {\n\n    @property\n    public moveSpeed = 1;\n\n    @property\n    public moveSpeedShiftScale = 5;\n\n    @property({ slide: true, range: [0.05, 0.5, 0.01] })\n    public damp = 0.2;\n\n    @property\n    public rotateSpeed = 1;\n\n    public _euler = new Vec3();\n    public _velocity = new Vec3();\n    public _position = new Vec3();\n    public _speedScale = 1;\n\n    public onLoad () {\n        systemEvent.on(SystemEvent.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\n        systemEvent.on(SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\n        systemEvent.on(SystemEvent.EventType.KEY_UP, this.onKeyUp, this);\n        systemEvent.on(SystemEvent.EventType.TOUCH_START, this.onTouchStart, this);\n        systemEvent.on(SystemEvent.EventType.TOUCH_MOVE, this.onTouchMove, this);\n        systemEvent.on(SystemEvent.EventType.TOUCH_END, this.onTouchEnd, this);\n        Vec3.copy(this._euler, this.node.eulerAngles);\n        Vec3.copy(this._position, this.node.position);\n    }\n\n    public onDestroy () {\n        systemEvent.off(SystemEvent.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\n        systemEvent.off(SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\n        systemEvent.off(SystemEvent.EventType.KEY_UP, this.onKeyUp, this);\n        systemEvent.off(SystemEvent.EventType.TOUCH_START, this.onTouchStart, this);\n        systemEvent.off(SystemEvent.EventType.TOUCH_MOVE, this.onTouchMove, this);\n        systemEvent.off(SystemEvent.EventType.TOUCH_END, this.onTouchEnd, this);\n    }\n\n    public update (dt: number) {\n        // position\n        Vec3.transformQuat(v3_1, this._velocity, this.node.rotation);\n        Vec3.scaleAndAdd(this._position, this._position, v3_1, this.moveSpeed * this._speedScale);\n        Vec3.lerp(v3_1, this.node.position, this._position, dt / this.damp);\n        this.node.setPosition(v3_1);\n        // rotation\n        Quat.fromEuler(qt_1, this._euler.x, this._euler.y, this._euler.z);\n        Quat.slerp(qt_1, this.node.rotation, qt_1, dt / this.damp);\n        this.node.setRotation(qt_1);\n    }\n\n    public onMouseWheel (e: EventMouse) {\n        const delta = -e.getScrollY() * this.moveSpeed * 0.1; // delta is positive when scroll down\n        Vec3.transformQuat(v3_1, Vec3.UNIT_Z, this.node.rotation);\n        Vec3.scaleAndAdd(this._position, this.node.position, v3_1, delta);\n    }\n\n    public onKeyDown (e: EventKeyboard) {\n        const v = this._velocity;\n        if      (e.keyCode === KEYCODE.SHIFT) { this._speedScale = this.moveSpeedShiftScale; }\n        else if (e.keyCode === KEYCODE.W) { if (v.z === 0) { v.z = -1; } }\n        else if (e.keyCode === KEYCODE.S) { if (v.z === 0) { v.z =  1; } }\n        else if (e.keyCode === KEYCODE.A) { if (v.x === 0) { v.x = -1; } }\n        else if (e.keyCode === KEYCODE.D) { if (v.x === 0) { v.x =  1; } }\n        else if (e.keyCode === KEYCODE.Q) { if (v.y === 0) { v.y = -1; } }\n        else if (e.keyCode === KEYCODE.E) { if (v.y === 0) { v.y =  1; } }\n    }\n\n    public onKeyUp(e: EventKeyboard) {\n        const v = this._velocity;\n        if      (e.keyCode === KEYCODE.SHIFT) { this._speedScale = 1; }\n        else if (e.keyCode === KEYCODE.W) { if (v.z < 0) { v.z = 0; } }\n        else if (e.keyCode === KEYCODE.S) { if (v.z > 0) { v.z = 0; } }\n        else if (e.keyCode === KEYCODE.A) { if (v.x < 0) { v.x = 0; } }\n        else if (e.keyCode === KEYCODE.D) { if (v.x > 0) { v.x = 0; } }\n        else if (e.keyCode === KEYCODE.Q) { if (v.y < 0) { v.y = 0; } }\n        else if (e.keyCode === KEYCODE.E) { if (v.y > 0) { v.y = 0; } }\n    }\n\n    public onTouchStart () {\n        if (game.canvas!['requestPointerLock']) { game.canvas!.requestPointerLock(); }\n    }\n\n    public onTouchMove (t: Touch, e: EventTouch) {\n        e.getStartLocation(v2_1);\n        if (v2_1.x > game.canvas!.width * 0.4) { // rotation\n            e.getDelta(v2_2);\n            this._euler.y -= v2_2.x * this.rotateSpeed * 0.1;\n            this._euler.x += v2_2.y * this.rotateSpeed * 0.1;\n        } else { // position\n            e.getLocation(v2_2);\n            Vec2.subtract(v2_2, v2_2, v2_1);\n            this._velocity.x = v2_2.x * 0.01;\n            this._velocity.z = -v2_2.y * 0.01;\n        }\n    }\n\n    public onTouchEnd(t: Touch, e: EventTouch) {\n        if (document.exitPointerLock) { document.exitPointerLock(); }\n        e.getStartLocation(v2_1);\n        if (v2_1.x < game.canvas!.width * 0.4) { // position\n            this._velocity.x = 0;\n            this._velocity.z = 0;\n        }\n    }\n}\n"]}